# 処置群のみ分析機能　実装ロードマップ

## 概要

このドキュメントは、既存のCausal Impactアプリケーションに「処置群のみ分析」機能を追加するための実装ロードマップです。

## 分析手法の比較・選定

### 検討した手法

1. **Causal Impact拡張（推奨）**
   - 既存システムとの親和性が高い
   - ベイズ構造時系列モデルによる堅牢な分析
   - 季節性・トレンドパターンを適切に考慮

2. **中断時系列分析（ITS）**
   - 医学・公共政策分野で標準的
   - レベル変化・トレンド変化を区別して分析
   - より解釈しやすい回帰ベースの手法

### 選定理由

**メイン手法: Causal Impact拡張**
- 現在のユーザーが慣れ親しんだ分析結果形式を維持
- 既存コードベースの大幅な変更が不要
- ベイズ推定による不確実性の適切な表現

**オプション手法: ITS**
- より統計学的に解釈しやすい結果
- 効果の詳細な分解（即座の効果 vs 長期的効果）
- 学術・実務での標準的手法

## 実装フェーズ

### フェーズ1: 基盤機能実装（優先度：高）

#### 1.1 UI拡張
- [x] 分析タイプ選択ラジオボタン追加
- [x] 処置群のみデータアップロード機能
- [x] アップロード方法に応じたUI分岐

#### 1.2 データ処理機能
- [x] 処置群のみデータ検証機能（`validate_single_group_data`）
- [x] 介入ポイント自動推奨機能（`suggest_intervention_point`）
- [ ] セッション状態管理の拡張

#### 1.3 分析エンジン
- [x] Causal Impact処置群のみ対応（`run_single_group_causal_impact_analysis`）
- [x] 結果サマリー生成（`build_single_group_summary_dataframe`）
- [x] 結果解釈機能（`get_single_group_interpretation`）

### フェーズ2: STEP2・STEP3統合（優先度：高）

#### 2.1 STEP2期間設定の拡張
- [ ] 処置群のみ分析用の期間設定UI
- [ ] 介入前期間の充足性チェック（最低60%ルール）
- [ ] 推奨介入ポイントの表示・選択機能

#### 2.2 STEP3分析実行の統合
- [ ] 分析タイプに応じた分析関数の分岐
- [ ] 処置群のみ分析結果の表示・ダウンロード機能
- [ ] 既存の標準分析との結果形式統一

### フェーズ3: 高度な機能追加（優先度：中）

#### 3.1 ITS分析オプション
- [x] ITS分析エンジン実装（`utils_its_analysis.py`）
- [ ] ITS分析のSTEP3統合
- [ ] 分析手法選択UI（Causal Impact vs ITS）

#### 3.2 季節性パラメータ最適化
- [ ] 自動季節性検出機能
- [ ] 週次・月次・年次パターンの最適化
- [ ] パラメータ推奨機能

#### 3.3 結果解釈の強化
- [ ] 対照群なし分析特有の注意事項表示
- [ ] 効果の信頼性スコア算出
- [ ] 外部要因考慮のガイダンス

### フェーズ4: UX向上・最適化（優先度：低）

#### 4.1 データ品質診断
- [ ] データ期間の充足性評価
- [ ] 季節性・トレンドパターンの可視化
- [ ] 介入ポイント妥当性診断

#### 4.2 比較分析機能
- [ ] 複数介入ポイントでの感度分析
- [ ] Causal Impact vs ITS結果比較
- [ ] 分析手法推奨システム

## 技術仕様

### 必要な依存関係の追加

```python
# requirements.txtに追加
statsmodels>=0.14.0
scikit-learn>=1.3.0
```

### ファイル構成

```
project_root/
├── app_enhanced.py              # 拡張版メインアプリ
├── utils_step3_single_group.py  # 処置群のみCausal Impact分析
├── utils_its_analysis.py        # ITS分析（オプション）
├── config/
│   └── help_texts.py           # UI文言追加
└── docs/
    └── implementation_roadmap.md # このファイル
```

### セッション状態の拡張

```python
# 追加が必要なセッション状態
st.session_state.analysis_type = "標準分析（処置群 + 対照群）"
st.session_state.single_group_data = None
st.session_state.suggested_intervention_date = None
st.session_state.intervention_point_manual_override = False
```

## 実装上の注意事項

### 1. 既存機能への影響
- 標準分析（処置群+対照群）の既存機能は完全に維持
- セッション状態の構造的変更は最小限に抑制
- 既存ユーザーへの影響を避けるため、デフォルトは標準分析

### 2. データ検証の強化
- 処置群のみ分析では介入前期間が全体の60%以上必要
- 最低37日間のデータを推奨（季節性学習のため）
- 欠損値・異常値のより厳密なチェック

### 3. 結果解釈の注意事項
- 対照群なしの制約を明確に表示
- 外部要因の影響可能性を常に言及
- 結果の確実性レベルを定量的に表示

### 4. パフォーマンス考慮
- 処置群のみ分析は標準分析より計算量大
- 大量データでの処理時間警告
- 分析中のプログレスバー表示

## テスト戦略

### 1. 単体テスト
- [ ] 各分析関数の正常系・異常系テスト
- [ ] データ検証ロジックのテスト
- [ ] UI状態管理のテスト

### 2. 統合テスト
- [ ] 標準分析→処置群のみ分析の切り替えテスト
- [ ] セッション状態の保持・リセットテスト
- [ ] ファイルアップロード→分析→結果表示の全工程テスト

### 3. パフォーマンステスト
- [ ] 大量データでの処理時間測定
- [ ] メモリ使用量の監視
- [ ] 複数ユーザー同時利用テスト

## デプロイ計画

### ステージング環境
1. フェーズ1完了後、ステージング環境でのベータテスト
2. 限定ユーザーでの機能検証
3. フィードバック収集・改善

### 本番環境
1. フェーズ2完了後、本番環境への段階的デプロイ
2. 機能フラグによる段階的公開
3. 監視・ログ収集体制の強化

## 完成時の期待効果

### ユーザー向け価値
- 対照群データが取得困難な場合でも効果測定が可能
- より多様なビジネスシーンでのCausal Impact活用
- 統計的手法の選択肢拡大による分析の柔軟性向上

### 技術的価値
- モジュラー設計による保守性向上
- 新たな分析手法追加の容易性
- コードベースの品質向上

---

**最終更新日**: 2024年12月
**ステータス**: フェーズ1基盤機能実装完了、フェーズ2統合作業中 