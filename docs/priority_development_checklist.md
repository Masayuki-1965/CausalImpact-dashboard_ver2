# 処置群のみ分析機能　優先順位付き開発計画チェックリスト

## 開発方針

### 第一優先：Causal Impact拡張方式による「処置群のみ分析」機能
- 既存のCausal Impact分析機能との親和性を最大限活用
- 3ステップ構成（データ取り込み／期間設定／分析実行）の完全維持
- 介入前期間のトレンドや季節性を踏まえた堅牢な分析実装

### 第二優先：ITS分析機能（オプション対応）
- 第一優先完了後の段階的実装
- 既存実装の保守・改良
- 将来的な機能拡張への準備

---

## 📋 第一優先タスク：Causal Impact拡張実装

### ✅ 完了済み基盤機能

#### 1.1 分析エンジン（コア機能）
- [x] **utils_step3_single_group.py** - 処置群のみCausal Impact分析エンジン
  - [x] `run_single_group_causal_impact_analysis()` - 分析実行関数
  - [x] `validate_single_group_data()` - データ妥当性チェック
  - [x] `suggest_intervention_point()` - 介入ポイント自動推奨
  - [x] `build_single_group_summary_dataframe()` - 結果サマリー生成
  - [x] `get_single_group_interpretation()` - 結果解釈生成

#### 1.2 UI基盤機能
- [x] **app_enhanced.py** - 拡張版メインアプリケーション
  - [x] 分析タイプ選択ラジオボタン（標準分析 vs 処置群のみ分析）
  - [x] 処置群のみデータアップロード機能（ファイル・テキスト入力）
  - [x] 分析タイプに応じた動的UI切り替え

### ✅ 完了 - STEP1統合（最優先）

#### 1.3 STEP1データ取り込み完全統合
- [x] **app_enhanced.py STEP1拡張**
  - [x] 処置群のみデータ読み込み処理の実装
  - [x] セッション状態管理の拡張（`analysis_type`、`single_group_data`等）
  - [x] 処置群のみデータのプレビュー・統計情報表示
  - [x] データ集計（月次・旬次）の処置群のみ対応

- [x] **データ検証強化**
  - [x] 処置群のみ分析の最低データ要件チェック（37日間）
  - [x] 介入前期間比率検証（60%以上）
  - [x] 季節性学習に必要なデータ量確認

### ✅ 完了 - STEP1可視化統合（最優先）

#### 1.4 STEP1時系列可視化機能拡張
- [x] **処置群のみ分析用可視化機能**
  - [x] 処置群のみデータの時系列プロット作成
  - [x] 推奨介入ポイントの可視化表示
  - [x] 介入前後期間の色分け表示
  - [x] 既存の標準分析可視化との統合

- [x] **可視化UI統合**
  - [x] 分析タイプに応じた可視化の分岐処理
  - [x] Plotlyインタラクティブグラフの処置群のみ対応
  - [x] 可視化ガイドテキストの拡張

### 🚧 進行中 - STEP2統合（現在の最優先）

#### 1.5 STEP2期間設定機能拡張
- [ ] **期間設定UI拡張**
  - [ ] 分析タイプに応じた期間設定画面の分岐
  - [ ] 処置群のみ分析用の介入ポイント推奨表示
  - [ ] 介入前期間充足性の視覚的チェック機能

- [ ] **介入ポイント最適化**
  - [ ] 推奨介入ポイントの自動算出・表示
  - [ ] ユーザーによる手動調整機能
  - [ ] 期間設定の妥当性リアルタイム確認

### 🎯 次期実装 - STEP3統合（第三優先）

#### 1.6 STEP3分析実行統合
- [ ] **分析処理分岐実装**
  - [ ] 分析タイプに応じた処理関数の呼び分け
  - [ ] 処置群のみ分析のパラメータ設定統合
  - [ ] エラーハンドリングの統一

- [ ] **結果表示統合**
  - [ ] 処置群のみ分析結果の表示フォーマット統一
  - [ ] 既存ダウンロード機能の拡張（CSV、PDF）
  - [ ] 対照群なし分析特有の注意事項表示

### 🔧 最終調整・品質向上

#### 1.7 統合テスト・品質保証
- [ ] **統合テスト実施**
  - [ ] STEP1→STEP2→STEP3の全工程テスト
  - [ ] 標準分析から処置群のみ分析への切り替えテスト
  - [ ] セッション状態管理の正常性確認

- [ ] **UX最適化**
  - [ ] 処置群のみ分析の操作フロー最適化
  - [ ] ヘルプテキスト・ガイダンスの充実
  - [ ] エラーメッセージの改善

---

## 🔄 第二優先タスク：ITS分析機能（保守・準備）

### ✅ 完了済み基盤実装

#### 2.1 ITS分析エンジン
- [x] **utils_its_analysis.py** - ITS分析機能完全実装
  - [x] `run_interrupted_time_series_analysis()` - ITS分析実行
  - [x] `interpret_its_results()` - 結果解釈生成
  - [x] `create_its_plot()` - 分析結果プロット作成
  - [x] `validate_its_data()` - データ検証
  - [x] `suggest_its_intervention_point()` - 介入ポイント推奨

### 🛠️ 保守対象（第一優先完了後に着手）

#### 2.2 ITS分析UI統合（将来実装）
- [ ] **分析手法選択機能**
  - [ ] Causal Impact vs ITS の選択UI
  - [ ] 手法別パラメータ設定画面
  - [ ] 分析手法推奨システム

- [ ] **ITS結果表示統合**
  - [ ] ITS分析結果のStreamlit UI統合
  - [ ] Causal Impactとの結果比較機能
  - [ ] ITS特有の解釈表示（レベル変化・トレンド変化）

---

## 📅 実装スケジュール

### Phase 1：STEP1統合完成（最優先）
**目標期間：1-2週間**
- STEP1の処置群のみ分析完全対応
- データ読み込み〜データセット作成の全工程実装
- 基本的な動作確認・デバッグ

### Phase 2：STEP2統合完成（第二優先）
**目標期間：1週間**
- 期間設定機能の拡張
- 介入ポイント推奨機能の統合
- パラメータ設定のユーザビリティ向上

### Phase 3：STEP3統合完成（第三優先）
**目標期間：1週間**
- 分析実行機能の統合
- 結果表示・ダウンロード機能の完成
- 全機能の統合テスト

### Phase 4：品質向上・最終調整
**目標期間：3-5日**
- 統合テスト・バグ修正
- UX最適化・ドキュメント整備
- 本番環境デプロイ準備

---

## 🎯 今すぐ着手すべきタスク

### 最優先（即座に着手）
1. **STEP2期間設定機能の統合実装**
   - 処置群のみ分析用の期間設定UI拡張
   - 推奨介入ポイントの自動表示・手動調整機能
   - 分析タイプに応じた期間設定画面の分岐

2. **介入ポイント最適化とユーザビリティ向上**
   - 介入前期間充足性の視覚的チェック機能
   - 期間設定の妥当性リアルタイム確認
   - STEP2からSTEP3への遷移機能

### 次に着手（Phase 1完了後）
3. **STEP2期間設定機能の拡張**
   - 介入ポイント推奨機能の統合
   - 期間設定UIの分岐実装

4. **STEP3分析実行機能の統合**
   - 分析処理の分岐実装
   - 結果表示の統一

---

## 📊 成功指標

### Phase 1完了時点
- [x] 処置群のみデータでSTEP1が完全動作
- [x] データプレビュー・統計情報が正常表示
- [x] セッション状態が適切に管理される
- [x] 時系列可視化が処置群のみ分析に対応
- [x] 推奨介入ポイントが可視化される
- [ ] STEP2期間設定が処置群のみ分析に対応
- [ ] 推奨介入ポイントが期間設定に反映される

### 全Phase完了時点
- [ ] 3ステップ構成で処置群のみ分析が完全実行可能
- [ ] 分析結果の表示・ダウンロードが標準分析と同等
- [ ] 既存の標準分析機能に影響がない
- [ ] ユーザーが直感的に操作できるUX

---

**最終更新日**: 2024年12月  
**現在のステータス**: Phase 2実装中（STEP2期間設定統合）  
**次のマイルストーン**: 処置群のみ分析のSTEP2期間設定完成 