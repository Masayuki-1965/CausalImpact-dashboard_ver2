# リファクタリング計画 Phase 6（ITS分析統合前の準備）

## 📋 リファクタリング対象範囲と目的

### 🎯 目的
次期開発フェーズ（ITS分析機能統合）に向けて、コードベースの保守性・拡張性を向上させ、新機能追加を効率化する。

### 📊 現状分析結果

#### 重複コード・類似処理の特定
1. **データ読み込み処理の重複**
   - `load_and_clean_csv()` (utils_step1.py)
   - `load_and_clean_uploaded_csv()` (app_enhanced.py, app.py)
   - `load_and_clean_csv_text()` (app_enhanced.py, app.py)

2. **データ集計処理の重複**
   - `aggregate_df()` (utils_step1.py, app.py)

3. **サマリーテーブル作成処理の複雑化**
   - 単群推定用：2つの関数（unified, text_based）
   - 二群比較用：4つの関数（unified, text_based, enhanced, fallback）

4. **期間データ生成処理の重複**
   - `create_full_period_range()` (app.py内)
   - `create_single_group_dataset()` (app_enhanced.py内)

---

## 🔧 リファクタリング実行計画

### Phase 6.1: データ処理共通化 【優先度：高】

#### 6.1.1 データ読み込み処理の統一
**対象ファイル**: `utils_data_loader.py` (新規作成)
**統合対象**:
- `load_and_clean_csv()` → `load_csv_from_file()`
- `load_and_clean_uploaded_csv()` → `load_csv_from_upload()`
- `load_and_clean_csv_text()` → `load_csv_from_text()`

**効果**:
- 重複コード削減（約200行削減見込み）
- エラーハンドリングの統一
- 新しいデータ形式への対応容易化

#### 6.1.2 データ集計・期間生成処理の統一
**対象ファイル**: `utils_data_processor.py` (新規作成)
**統合対象**:
- `aggregate_df()` → `aggregate_timeseries_data()`
- 期間生成処理 → `generate_period_range()`
- データセット作成 → `create_analysis_dataset()`

**効果**:
- 二群比較・単群推定の処理統一
- ITS分析への拡張容易化

### Phase 6.2: 分析結果処理の整理 【優先度：中】

#### 6.2.1 サマリーテーブル作成処理の統一
**対象ファイル**: `utils_summary_builder.py` (新規作成)
**統合対象**:
- 6つのサマリー作成関数 → 2つの統一関数
  - `build_summary_table()` (メイン関数)
  - `build_summary_table_fallback()` (フォールバック関数)

**効果**:
- 日本語化処理の統一
- 新しい分析手法（ITS）への対応容易化
- メンテナンス性向上

#### 6.2.2 PDF・CSV出力処理の整理
**対象ファイル**: `utils_export.py` (新規作成)
**統合対象**:
- PDF生成関数の統一
- CSV生成関数の統一

### Phase 6.3: 設定・定数管理の強化 【優先度：低】

#### 6.3.1 分析手法設定の拡張
**対象ファイル**: `config/analysis_methods.py` (新規作成)
**内容**:
- 分析手法の定義（CausalImpact, ITS）
- パラメータ設定の統一管理
- 分析手法別の設定値管理

---

## 📅 実装スケジュール

### 推奨実施タイミング
**ITS分析機能統合開始前**（次期開発フェーズの最初の1-2日）

### 段階的実施計画
1. **Phase 6.1**: データ処理共通化（1日）
2. **Phase 6.2**: 分析結果処理整理（1日）
3. **Phase 6.3**: 設定管理強化（0.5日）

### 実施後の効果測定
- コード行数削減：約300-400行削減見込み
- ファイル数整理：メインファイル2-3個削減
- 新機能追加時間短縮：約30-40%短縮見込み

---

## ⚠️ リスク評価と対策

### 主要リスク
1. **既存機能への影響**
   - 対策：段階的移行・十分なテスト実施
2. **開発時間の増加**
   - 対策：必要最小限の範囲に限定・優先度付け

### 実施判断基準
- **実施推奨**: ITS分析機能が大規模な場合
- **実施見送り**: ITS分析機能が小規模で短期完了予定の場合

---

## 📝 実施可否の最終判断

### 実施推奨条件
- ITS分析機能の開発期間が1週間以上見込まれる場合
- 将来的に他の分析手法追加予定がある場合
- コードベースの長期保守を重視する場合

### 実施見送り条件
- ITS分析機能が軽微な追加で完了する場合
- 短期間でのリリースを最優先する場合

**推奨**: 現在のコードベースは十分に整理されており、ITS分析機能の規模を確認してから実施可否を判断することを推奨します。 