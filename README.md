# CausalImpact-Analyzer_ver2

因果推論分析（CausalImpact）のためのWebアプリケーション

## 特徴

### 🔧 分析機能
- **二群比較分析**: 処置群と対照群を使用した高精度な因果効果推定
- **単群推定分析**: 処置群のみを使用した因果効果推定（対照群がない場合）
- **動的信頼水準**: 95%、90%等の信頼水準をユーザー指定可能
- **自動品質評価**: データ量、期間配分等の分析品質を自動チェック

### 📊 出力機能
- **インタラクティブグラフ**: 実測値vs予測値、時点効果、累積効果の3つのグラフ
- **詳細サマリーテーブル**: 統計値、信頼区間、p値等の分析結果
- **PDF出力**: 分析結果レポートの包括的PDF生成
- **CSV出力**: 詳細データと分析サマリーのCSVダウンロード

### 🌐 多環境対応
- **Streamlit Cloud**: クラウド環境での安定動作
- **ローカルPC**: Windows/macOS/Linuxでの動作確認済み
- **日本語表示**: アプリ画面は常時日本語、PDF出力は環境自動判定
- **フォント最適化**: 環境に応じた日本語フォント自動設定

## Streamlit Cloud対応

本アプリケーションはStreamlit Cloudでの動作を最適化しています：

### 日本語表示対応
- **アプリ画面**: サマリーテーブル、グラフ説明は常時日本語表示
- **グラフタイトル**: Cloud環境では英語、PC環境では日本語を自動選択
- **PDF出力**: 環境に応じて文字化け回避処理を実行

### フォント処理
- クラウド環境での日本語フォント利用制限に対応
- 自動環境判定による最適なフォント選択
- 文字化け防止のための複数フォールバック機能

## インストール

### 必要なライブラリ
```bash
pip install streamlit pandas numpy matplotlib causalimpact plotly japanize-matplotlib reportlab
```

### 実行方法
```bash
streamlit run app_enhanced.py
```

## 使用方法

### 1. データ準備
- **ファイルアップロード**: CSVファイルをアップロード（推奨）
- **テキスト入力**: CSVデータを直接コピー&ペースト

#### データ形式
```csv
ymd,qty
20240101,1250
20240102,1180
20240103,1340
...
```

### 2. 分析設定
- **分析タイプ**: 二群比較 or 単群推定
- **介入期間**: 分析期間の開始・終了日指定
- **信頼水準**: 95%、90%等の信頼水準選択
- **データ頻度**: 日次、週次、月次の選択

### 3. 結果確認
- グラフによる視覚的確認
- サマリーテーブルでの数値確認
- 分析品質評価の確認
- 結果の解釈と推奨事項

### 4. 結果出力
- PDF形式での包括的レポート
- CSV形式での詳細データ

## 技術仕様

### アーキテクチャ
- **フロントエンド**: Streamlit
- **バックエンド**: Python (pandas, numpy)
- **分析エンジン**: CausalImpact (R→Python移植版)
- **グラフ生成**: matplotlib, plotly
- **PDF生成**: reportlab

### ファイル構成
```
├── app_enhanced.py              # メインアプリケーション
├── utils_step3.py               # 二群比較分析処理
├── utils_step3_single_group.py  # 単群推定分析処理
├── config/
│   ├── app_templates.py         # アプリ画面用日本語テンプレート
│   └── graph_config.py          # グラフ設定・環境判定
├── README.md
└── CHANGELOG.md
```

### 環境判定ロジック
```python
def is_japanese_font_available_for_graphs():
    system = platform.system()
    # Windows・macOSでは日本語フォント利用可能
    if system in ["Windows", "Darwin"]:
        return True
    # Linux（Streamlit Cloud）では英語フォント使用
    else:
        return False
```

## 分析手法

### 二群比較分析
- 対照群との関係から処置群の「介入がなかった場合」の値を予測
- 外部要因の影響を適切に除去
- より信頼性の高い因果効果推定

### 単群推定分析
- 介入前のトレンドから「介入がなかった場合」の値を予測
- 対照群がない場合の分析手法
- 外部要因の影響に注意が必要

### 品質評価基準
- **データ量**: 二群比較24件以上、単群推定36件以上推奨
- **期間配分**: 単群推定では介入前期間60%以上推奨
- **統計的有意性**: 信頼区間が0を含まない場合に有意
- **効果サイズ**: 実用的な効果の大きさも併せて評価

## トラブルシューティング

### よくある問題
1. **文字化け**: 環境判定により自動対応済み
2. **データ読み込みエラー**: CSV形式・エンコーディングを確認
3. **分析エラー**: データ量・期間設定を確認
4. **グラフ表示エラー**: ブラウザのリロードを試行

### サポート
- エラーメッセージに基づく自動診断機能
- 段階的フォールバック処理による安定動作
- 詳細なログ出力によるデバッグ支援

## 更新履歴

最新の変更内容は[CHANGELOG.md](CHANGELOG.md)をご確認ください。

## ライセンス

MIT License

---

**開発・保守**: CausalImpact-Analyzer Development Team
**最終更新**: 2024-12-19 